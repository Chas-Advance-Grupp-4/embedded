#!/bin/bash

echo "Running pre-commit checks..."

# --- Backend (Python / FastAPI) ---
if [ -d "app" ] && [ -f "requirements.txt" ]; then
  echo "Backend detected (Python/FastAPI)."

  # echo "Checking Python formatting with Black..."
  # black --check app
  # if [ $? -ne 0 ]; then
  #   echo ""
  #   echo "Black formatting failed."
  #   echo "Fix it with:"
  #   echo "  black app"
  #   exit 1
  # fi

  # echo "Linting Python code with Flake8..."
  # flake8 app
  # if [ $? -ne 0 ]; then
  #   echo ""
  #   echo "Flake8 found linting issues."
  #   echo "Fix them with:"
  #   echo "  flake8 app"
  #   exit 1
  # fi

  # if [ -f ".secrets.baseline" ]; then
  #   echo "Checking for secrets with detect-secrets..."
  #   detect-secrets scan --baseline .secrets.baseline
  #   if [ $? -ne 0 ]; then
  #     echo ""
  #     echo "Potential secrets detected."
  #     echo "Update baseline if necessary:"
  #     echo "  detect-secrets scan > .secrets.baseline"
  #     exit 1
  #   fi
  # fi

  # if [ -d "tests" ]; then
  #   echo "Running backend tests with pytest..."
  #   pytest -q --disable-warnings --maxfail=1 tests
  #   if [ $? -ne 0 ]; then
  #     echo ""
  #     echo "Some tests failed. Fix them and try again."
  #     exit 1
  #   fi
  # fi
fi

# --- PWA (Web) ---
# echo "Running frontend pre-commit checks..."
if [ -d "pwa" ]; then
  echo "Linting PWA (web) source files..."
  cd pwa || exit 1

  # ESLint
  # npx --no-install eslint "src/**/*.{ts,tsx,js,jsx}"
  # if [ $? -ne 0 ]; then
  #   echo "ESLint errors detected in PWA. Please fix them before committing."
  #   exit 1
  # fi

  # Prettier check
  # npx --no-install prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,scss,md}"
  # if [ $? -ne 0 ]; then
  #   echo "Prettier formatting issues found in PWA. Run 'npx prettier --write' to fix."
  #   exit 1
  # fi

  cd - > /dev/null || exit 1
fi

# --- Mobile (React Native / Expo) ---
if [ -d "mobile" ]; then
  echo "Linting mobile (React Native) source files..."
  cd mobile || exit 1

  # ESLint
  # npx --no-install eslint "src/**/*.{ts,tsx,js,jsx}"
  # if [ $? -ne 0 ]; then
  #   echo "ESLint errors detected in Mobile app. Please fix them before committing."
  #   exit 1
  # fi

  # Prettier check
  # npx --no-install prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,scss,md}"
  # if [ $? -ne 0 ]; then
  #   echo "Prettier formatting issues found in Mobile app. Run 'npx prettier --write' to fix."
  #   exit 1
  # fi

  cd - > /dev/null || exit 1
fi

# --- Embedded ---
REPO_NAME=$(basename "$(git rev-parse --show-toplevel)")
REPO_ROOT=$(git rev-parse --show-toplevel)
if [ "$REPO_NAME" = "embedded" ]; then
  echo "Embedded detected. Tests/checks can be added here later."
  
  # Allow commit if only cppcheck scripts or this hook are staged
  if git diff --cached --name-only | grep -qE '^(\.githooks/pre-commit|controlunit/helpers/cu_cppcheck\.sh|sensorunit/helpers/su_cppcheck\.sh)$'; then
  echo "Only cppcheck scripts or hook modified. Commit allowed."
  exit 0
  fi 

  if git diff --cached --name-only | grep -q '^controlunit/'; then
  	echo "Running cppcheck for controlunit..."
	cd "$REPO_ROOT/controlunit" || {
      echo "Failed to enter controlunit directory"
      exit 1
    }
  	bash helpers/cu_cppcheck.sh
	if [ $? -ne 0 ]; then
      echo "Cppcheck failed for controlunit. Commit aborted."
      exit 1
    fi
  fi

  if git diff --cached --name-only | grep -q '^sensorunit/'; then
    echo "Running cppcheck for sensorunit..."
	cd "$REPO_ROOT/sensorunit" || {
      echo "Failed to enter sensorunit directory"
      exit 1
    }
    bash helpers/su_cppcheck.sh
	if [ $? -ne 0 ]; then
      echo "Cppcheck failed for sensorunit. Commit aborted."
      exit 1
    fi
  fi

fi

echo "All pre-commit checks passed."
